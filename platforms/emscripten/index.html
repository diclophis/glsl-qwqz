<!doctype html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta charset="utf-8">
    <title>MemoryLeak</title>
    <style>
      html { margin: 0; padding: 0; height: 100%; }
      body { margin: 0; padding: 0; overflow: hidden; height: 100%; }
      canvas {
        width: 100%;
        height: 100%;
        background:
          linear-gradient(0deg, #000000 2px, rgba(0,0,0,0) 2px),
          linear-gradient(90deg, #000000 2px, rgba(0,0,0,0) 2px),
          linear-gradient(0deg, rgba(255,255,255,0.298039) 1px, rgba(0,0,0,0) 1px),
          linear-gradient(90deg, rgba(255,255,255,0.298039) 1px, rgba(0,0,0,0) 1px), rgb(134, 134, 134);
        x-background-position: -2px -2px, -2px -2px, -1px -1px, -1px -1px;
      }
    </style>
    <script>
      var queryString = (function(a) {
        var c = {}, b;
        if ("" != a) {
          for (b in a = a.substring(1).split("&")) {
            c[(b = a[b].split("="))[0]] = b[1];
          }
        }
        return c
      })(window.location.search);
      // Checking for an update. Always the first event fired in the sequence.
      window.applicationCache.addEventListener("checking", function(e) {
        window.clearTimeout(installerTimeout);
        //console.log("checking");
      }, false);

      // Fired after the first cache of the manifest.
      window.applicationCache.addEventListener("cached", function(e) {
        //console.log("cached");
      }, false);

      // An update was found. The browser is fetching resources.
      window.applicationCache.addEventListener('downloading', function(e) {
        //console.log("downloading");
      }, false);

      // The manifest returns 404 or 410, the download failed,
      // or the manifest changed while the download was in progress.
      window.applicationCache.addEventListener('error', function(e) {
        window.clearTimeout(installerTimeout);
        //console.log("error, not sure what to do here");
      }, false);

      // Fired after the first download of the manifest.
      window.applicationCache.addEventListener('noupdate', function(e) {
        window.clearTimeout(installerTimeout);
        //console.log("no update required....");
      }, false);

      // Fired if the manifest file returns a 404 or 410.
      // This results in the application cache being deleted.
      window.applicationCache.addEventListener('obsolete', function(e) {
        //console.log("cache is obsolete");
      }, false);

      // Fired for each resource listed in the manifest as it is being fetched.
      window.applicationCache.addEventListener('progress', function(e) {
        //console.log("progress");
      }, false);

      function onUpdateReady() {  
        //console.log("found new version!, SWAP()");  
        //window.applicationCache.swapCache();
      }

      window.applicationCache.addEventListener("updateready", onUpdateReady);  
      if(window.applicationCache.status === window.applicationCache.UPDATEREADY) {  
        onUpdateReady();  
      }
    </script>
  </head>
  <body>
    <canvas id="glut-window" width="0" height="0"></canvas>
    <script>
      var Module = {
        noInitialRun: true,
        print: function(text) {
          //console.log(text);
        },
        printErr: function(text) {
          //console.log(text);
        },
        setStatus: function(text) {
          //console.log(text);
        },
        canvas: document.getElementById("glut-window"),
        totalDependencies: 0,
        percentComplete: 0,
        leftCounter: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          this.percentComplete = parseInt(((this.totalDependencies-left) / this.totalDependencies) * 100.0);
          this.leftCounter = left;
          //this.canvas.style.width = percentComplete + "%";
          //this.canvas.style.height = percentComplete + "%";
          console.log("t", this.totalDependencies, "l", left, "perc", this.percentComplete);
          this.canvas.style.backgroundSize = "100px " + (102 - this.percentComplete) + "px, " + (102 - this.percentComplete) + "px 100px, 20px 20px, 20px 20px";
          //if (this.percentComplete == 100) {
          //debugger;
          //}
        },
        arguments: [
          //"assets/shaders/basic.vsh",
          //queryString["fragment"] || "assets/shaders/flower.fsh"
        ]
      };
    </script>
    <script src="raptor_island.js"></script>
    <script>
        var manifestFile = new XMLHttpRequest();
        var manifestUrl = "index.appcache";
        manifestFile.open("GET", manifestUrl, true);
        Module.addRunDependency("manifest");
        var fetchFileFromManifest = function(line) {
          if (line.indexOf("assets") == 0) {
            var lastSlashIndex = line.lastIndexOf("/");
            var dirName = line.substr(0, lastSlashIndex);
            var baseName = line.substr(lastSlashIndex + 1, line.length);
            var dataFile = new XMLHttpRequest();
            dataFile.open("GET", line, true);
            dataFile.responseType = "arraybuffer";
            Module.addRunDependency(line);
            dataFile.onload = function(e) {
              var arrayBuffer = this.response;
              var byteArray = arrayBuffer.byteLength ? new Uint8Array(arrayBuffer) : arrayBuffer;
              Module.FS_createDataFile(dirName, baseName, byteArray, true, false);
              //if (Module.leftCounter == 1) {
              //  setTimeout(function() {
              //    Module.removeRunDependency(line);
              //  }, 200);
              //} else {
                Module.removeRunDependency(line);
              //}
//console.log("p", Module.percentComplete, Module.leftCounter);
            }
            dataFile.send(null);
          }
        };
        manifestFile.onload = function(e) {
          var assets = Module.FS_createFolder("/", "assets", true, true);
          var shaders = Module.FS_createFolder(assets, "shaders", true, true);
          var textures = Module.FS_createFolder(assets, "textures", true, true);
          var spine = Module.FS_createFolder(assets, "spine", true, true);
          var lines = this.response.split("\n");
          for (var i=0; i<lines.length; i++) {
            fetchFileFromManifest(lines[i]);
          }
          Module.removeRunDependency("manifest");
        };
        manifestFile.send(null);
    </script>
  </body>
</html>
